[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

#AzFile Source
$AzFileSource = "https://github.com/Azure-Samples/azure-files-samples/releases/download/v0.2.3/AzFilesHybrid.zip"

#Download Location
$locationAzFiledownload = "D:\AzFilesHybrid.zip"

#Folder Name
$folder = "D:\AzFileHybrid"

#Folder Creation for Unzip
New-Item -Path $folder -ItemType Directory

#Download AzFile
Invoke-WebRequest -Uri $AzFileSource -OutFile $locationAzFiledownload

#Unzip AzFile
Expand-Archive D:\AzFilesHybrid.zip -DestinationPath D:\AzFileHybrid

Install-Module AZ

Import-Module AZ

Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser

cd D:\AzFileHybrid

.\CopyToPSPath.ps1

Import-Module -Name AzFilesHybrid

Connect-AzAccount

$SubscriptionId = "<your-subscription-id-here>"
$ResourceGroupName = "<resource-group-name-here>"
$StorageAccountName = "<storage-account-name-here>"

Select-AzSubscription -SubscriptionId $SubscriptionId

Join-AzStorageAccountForAuth `
        -ResourceGroupName $ResourceGroupName `
        -Name $StorageAccountName `
        -DomainAccountType "ComputerAccount" `
        #-DomainAccountType "ServiceLogonAccount"
        -OrganizationalUnitName "<ou-name-here>" 
        # OR USE A DISTINGUISHED NAME
        #-OrganizationalUnitDistinguishedName "<ou-distinguishedname-here>"

# Get the target storage account
$storageaccount = Get-AzStorageAccount `
        -ResourceGroupName $ResourceGroupName `
        -Name $StorageAccountName

# List the directory service of the selected service account
$storageAccount.AzureFilesIdentityBasedAuth.DirectoryServiceOptions

# List the directory domain information if the storage account has enabled
#AD DS authentication for file shares
$storageAccount.AzureFilesIdentityBasedAuth.ActiveDirectoryProperties
